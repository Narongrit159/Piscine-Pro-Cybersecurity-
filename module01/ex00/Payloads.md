# Payloads

## ขั้นที่ 1: ตรวจสอบว่าเป็น Template Injection

หน้าเว็บนี้มีช่องโหว่ Server-Side Template Injection (SSTI) เนื่องจากระบบนำข้อมูลจากช่อง Input ไปประมวลผลผ่าน Template Engine โดยตรง หากคุณลองพิมพ์ {{ 7*7 }} แล้วผลลัพธ์แสดงเป็น Hello, 49! แสดงว่าระบบใช้ Jinja2 (Python) เป็น Engine ในการประมวลผลครับ

ทดสอบด้วย expression ทางคณิตศาสตร์ของ template engine เช่น

{{ 7 * 7 }}

ผลลัพธ์:
หากหน้าเว็บแสดงค่า 49 แสดงว่า input ถูกประมวลผลโดย template engine

ทดสอบด้วย
Payload นี้จะไล่ลำดับจาก Object ปัจจุบัน (self) ไปยัง Global scope ของ Python เพื่อเรียกใช้ฟังก์ชัน open() ซึ่งเป็นฟังก์ชันมาตรฐานที่ใช้เปิดอ่านไฟล์ในเครื่องเซิร์ฟเวอร์

{{ self.__init__.__globals__.__builtins__['open']('/etc/passwd').read() }}

ทดสอบด้วย
{{ self.__init__.__globals__.__builtins__.__import__('os').popen('ls -la').read() }}

## สรุปคำสั่ง

{{ ... }}: เป็นสัญลักษณ์ที่ Template Engine (ในที่นี้คือ Jinja2 ของ Python) ใช้เพื่อบอกว่า "ให้ประมวลผลคำสั่งข้างในนี้แล้วแสดงผลออกมา"

self: คือ Object ปัจจุบันที่กำลังทำงานอยู่ใน Template

.**init**: คือ Method ที่ใช้เริ่มต้นสร้าง Object นั้นๆ ซึ่งจะพาเราเข้าถึงโครงสร้างภายในของภาษา Python

.**globals**: เป็นพจนานุกรม (Dictionary) ที่เก็บตัวแปรและฟังก์ชันทั้งหมดที่ Object นั้นสามารถมองเห็นได้ รวมถึง Library ต่างๆ ด้วย

.**builtins**: คือแหล่งรวมฟังก์ชันพื้นฐานของ Python ที่มีมาให้แต่เกิด (เช่น print, len, หรือ open)
['open']('/etc/passwd'): เมื่อเราเข้าถึง Built-ins ได้ เราจึงสั่งเรียกฟังก์ชัน open เพื่อเปิดไฟล์ที่ชื่อว่า /etc/passwd ซึ่งเป็นไฟล์สำคัญในระบบ Linux ที่เก็บรายชื่อ User
.read(): คือคำสั่งให้อ่านเนื้อหาข้างในไฟล์ที่เปิดขึ้นมา เพื่อนำมาแสดงผลบนหน้าจอเว็บ

## ขั้นที่ 2: ตรวจสอบการเข้าถึง object ภายใน

ทดสอบด้วย expression ที่อ้างอิง object พื้นฐานของ engine
(เช่น config, self, หรือ context variables)

ผลลัพธ์:
พบว่าสามารถเข้าถึง object ภายในได้

## ขั้นที่ 3: พิสูจน์ผลกระทบ

ใช้ความสามารถของ template engine เพื่ออ่านไฟล์ในระบบ
ทำให้สามารถแสดงเนื้อหาของไฟล์เป้าหมายบนหน้าเว็บได้

ผลลัพธ์:
สามารถอ่านไฟล์ภายในเครื่อง server ได้ตามโจทย์

## สรุป

เว็บมีช่องโหว่ SSTI เนื่องจากนำ input ผู้ใช้ไป render โดยตรง
ทำให้ attacker ควบคุมการประมวลผลของ template engine ได้
